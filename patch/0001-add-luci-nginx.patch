From aed786f6a8c9b5e07537d5c4f527e32e533c026d Mon Sep 17 00:00:00 2001
From: w01230 <4585006@gmail.com>
Date: Wed, 27 Jun 2018 16:35:05 +0800
Subject: [PATCH] add luci-nginx

---
 collections/luci-nginx/Makefile             | 23 +++++++++++++++++++++
 collections/luci-ssl-nginx/Makefile         | 19 +++++++++++++++++
 collections/luci-ssl-openssl-nginx/Makefile | 21 +++++++++++++++++++
 collections/luci/Makefile                   |  2 +-
 modules/luci-base/luasrc/dispatcher.lua     |  2 +-
 modules/luci-base/root/etc/config/luci      |  2 +-
 6 files changed, 66 insertions(+), 3 deletions(-)
 create mode 100644 collections/luci-nginx/Makefile
 create mode 100644 collections/luci-ssl-nginx/Makefile
 create mode 100644 collections/luci-ssl-openssl-nginx/Makefile

diff --git a/collections/luci-nginx/Makefile b/collections/luci-nginx/Makefile
new file mode 100644
index 0000000..8024719
--- /dev/null
+++ b/collections/luci-nginx/Makefile
@@ -0,0 +1,23 @@
+#
+# Copyright (C) 2008-2014 The LuCI Team <luci@lists.subsignal.org>
+#
+# This is free software, licensed under the Apache License, Version 2.0 .
+#
+
+include $(TOPDIR)/rules.mk
+
+LUCI_TYPE:=col
+LUCI_BASENAME:=nginx
+
+LUCI_TITLE:=LuCI interface with Nginx as Webserver
+LUCI_DESCRIPTION:=Standard OpenWrt set including full admin with ppp support and the default Bootstrap theme
+LUCI_DEPENDS:= \
+	+nginx +nginx-mod-luci +luci-mod-admin-full +luci-theme-atmaterial \
+	+luci-app-firewall +luci-proto-ppp +libiwinfo-lua +IPV6:luci-proto-ipv6 \
+	+rpcd-mod-rrdns
+
+PKG_LICENSE:=Apache-2.0
+
+include ../../luci.mk
+
+# call BuildPackage - OpenWrt buildroot signature
diff --git a/collections/luci-ssl-nginx/Makefile b/collections/luci-ssl-nginx/Makefile
new file mode 100644
index 0000000..d7ff49a
--- /dev/null
+++ b/collections/luci-ssl-nginx/Makefile
@@ -0,0 +1,19 @@
+#
+# Copyright (C) 2008-2016 The LuCI Team
+#
+# This is free software, licensed under the Apache License, Version 2.0 .
+#
+
+include $(TOPDIR)/rules.mk
+
+LUCI_TYPE:=col
+LUCI_BASENAME:=ssl
+
+LUCI_TITLE:=LuCI with HTTPS support (mbedTLS as SSL backend)
+LUCI_DEPENDS:=+luci-nginx +nginx-mod-luci-ssl +libustream-mbedtls +px5g
+
+PKG_LICENSE:=Apache-2.0
+
+include ../../luci.mk
+
+# call BuildPackage - OpenWrt buildroot signature
diff --git a/collections/luci-ssl-openssl-nginx/Makefile b/collections/luci-ssl-openssl-nginx/Makefile
new file mode 100644
index 0000000..5109647
--- /dev/null
+++ b/collections/luci-ssl-openssl-nginx/Makefile
@@ -0,0 +1,21 @@
+#
+# Copyright (C) 2016 The LuCI Team
+#
+# This is free software, licensed under the Apache License, Version 2.0 .
+#
+
+include $(TOPDIR)/rules.mk
+
+LUCI_TYPE:=col
+LUCI_BASENAME:=ssl-openssl
+
+LUCI_TITLE:=LuCI with HTTPS support (OpenSSL as SSL backend)
+LUCI_DESCRIPTION:=LuCI with OpenSSL as the SSL backend (libustream-openssl). \
+ OpenSSL cmd tools (openssl-util) are used by uhttpd for SSL key generation \
+ instead of the default px5g. (If px5g is installed, uhttpd will prefer that.)
+
+LUCI_DEPENDS:=+luci-nginx +nginx-mod-luci-ssl +libustream-openssl +openssl-util
+
+include ../../luci.mk
+
+# call BuildPackage - OpenWrt buildroot signature
diff --git a/collections/luci/Makefile b/collections/luci/Makefile
index 9b495c3..0d0ec62 100644
--- a/collections/luci/Makefile
+++ b/collections/luci/Makefile
@@ -11,7 +11,7 @@ LUCI_BASENAME:=luci
 
 LUCI_TITLE:=Standard OpenWrt set including full admin with ppp support and the default Bootstrap theme
 LUCI_DEPENDS:= \
-	+uhttpd +uhttpd-mod-ubus +luci-mod-admin-full +luci-theme-bootstrap \
+	+uhttpd +uhttpd-mod-ubus +luci-mod-admin-full +luci-theme-atmaterial \
 	+luci-app-firewall +luci-proto-ppp +libiwinfo-lua +IPV6:luci-proto-ipv6 \
 	+rpcd-mod-rrdns
 
diff --git a/modules/luci-base/luasrc/dispatcher.lua b/modules/luci-base/luasrc/dispatcher.lua
index 38932af..c599d52 100644
--- a/modules/luci-base/luasrc/dispatcher.lua
+++ b/modules/luci-base/luasrc/dispatcher.lua
@@ -357,7 +357,7 @@ function dispatch(request)
 			elseif key == "REQUEST_URI" then
 				return build_url(unpack(ctx.requestpath))
 			elseif key == "FULL_REQUEST_URI" then
-				local url = { http.getenv("SCRIPT_NAME"), http.getenv("PATH_INFO") }
+				local url = { http.getenv("SCRIPT_NAME") or "", http.getenv("PATH_INFO") }
 				local query = http.getenv("QUERY_STRING")
 				if query and #query > 0 then
 					url[#url+1] = "?"
diff --git a/modules/luci-base/root/etc/config/luci b/modules/luci-base/root/etc/config/luci
index baa3ac5..2fa00d4 100644
--- a/modules/luci-base/root/etc/config/luci
+++ b/modules/luci-base/root/etc/config/luci
@@ -1,6 +1,6 @@
 config core main
 	option lang auto
-	option mediaurlbase /luci-static/bootstrap
+	option mediaurlbase /luci-static/atmaterial
 	option resourcebase /luci-static/resources
 	
 config extern flash_keep
-- 
2.18.0

